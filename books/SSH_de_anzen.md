# SSHで安全なリモートアクセスを構築する
榊原 大輔. 株式会社ディー・アート, 2003.11.05

Finish reading at:

###### Purpose
Learn about SSH and able to setup SSH servers

## Notes
### 第1章 リモートアクセスとは何なのか
#### 1-3 リモートアクセスの利便性と危険性
- 一括操作: リモートアクセスを利用して，それぞれのコンピュータに含まれるデータを完全に同期させることができる

### 第2章 リモートアクセスにSSHを使用する理由
#### 2-1 SSHとは何か―SSHの概要
SSH: Secure Shell

SSHの3つの機能
- リモートアクセス処理
- 通信の暗号化
    - ポートフォワーディングによる他の通信プロトコルの暗号化
- 認証

#### 2-2 SSHの成り立ち
r系コマンド: UNIX系OS同士でリモートアクセスするためのコマンド

telnetやftpとの違い
- telnetはr系コマンドではrlogin, ftpはrcpで実現されている
- 一番の違いは，通信相手の想定
    - telnet, ftpは相手のコンピュータ環境は重視されない(TCP/IPプロトコルに準拠していれば通信可能)
    - r系コマンドでは相手がUNIX系OSであることを想定

代表的なr系コマンド
- rlogin: リモートログインのためのコマンド
- rcp: リモートアクセス時にファイルをコピーするためのコマンド
    - アカウント@ホスト名:ファイル名(ディレクトリ名)
    - e.g. `rcp ssh.txt user@host:/tmp`
- rsh: 接続先のコンピュータにコマンドを実行させるためのコマンド(リモートシェル)．TCP/IP標準プロトコルには対応するものがない．
    - `rsh -l user host 実行したいコマンド`
    - ローカルとリモートのユーザ名が同じなら`-l`オプションは省略できる

r系コマンドの弱点
- 認証能力がない
    - IPアドレスとユーザーの登録によって通信が可能になる．
- 暗号化されない

送信元IPアドレスの偽装は簡単(例え: 郵便物の送り元)

SSHによるr系コマンドの弱点を解決
- slogin
- scp
- ssh

#### 2-3 SSHで危険性に対応する+alpha
公開鍵暗号方式と共通鍵暗号方式による認証能力と通信の暗号化

公開鍵暗号方式: 公開鍵と秘密鍵
- 公開鍵: データの暗号化
- 秘密鍵: 暗号化されたデータの復元

SSHの通信の流れ
1. ホスト認証
2. ユーザー認証
3. 本番の通信

ホスト認証(リモートのローカルからの認証)
0. 初めてアクセスしてきた相手上のSSHに対して自分の公開鍵を渡す(リモート -> ローカル)
1. 公開鍵を使ってランダムに生成したデータを暗号化してリモートに送る
2. リモートは秘密鍵を使って暗号を解読し，そのデータをローカルに送り返す
3. ローカルは送ったデータと返ってきたデータを比較する
4. データが一致すれば，リモートは「リモートアクセスされる権利」を持つ相手だと判断できる

ユーザー認証(ローカルのリモートからの認証)
- ホスト認証と同様の仕組み(better)
- パスワードによる認証

SSHにおける共通鍵暗号方式の使われ方
- お互いが同じ鍵でデータの暗号化と復号化を行う
- 暗号化・復号化が公開鍵暗号方式よりも高速
- 共通鍵のやり取りは，公開鍵暗号方式で行う

SSHによるポートフォワーディング(+alpha)
- 他のプロトコルの通信のセキュリティレベルも上がる
- SSHの暗号化機能の1つとして扱う
- SSHの通信路を用いて転送
- 開けるファイアウォールを減らせる + 暗号化

#### 2-4 なぜ「SSH」を使うのか
- 導入が容易
- 拡張性(他のプロトコルと簡単に組み合わせられる)
- 多くのプラットフォームに対応

IPsecとの比較
- IPsecも転送中のデータを保護する
- 保護する層が異なる(IPsecはIP層，SSHはアプリケーション層)
- 前者は意識しない．後者はユーザーが意図的に使う
- IPsecは処理が重く，専用のハードウェアを必要とすることが多い
- 不特定多数のアクセスがくるサーバーなどには向かない

#### 2-5 本書で想定するネットワーク環境とSSHを取り巻く流れ
クライアント --インターネット-- ゲートウェイ - サーバ

- ルータは明記していない(どこにあっても変わらないため)

グローバルIPアドレス・プライベートIPアドレス問題
- 上を変換するためにルータが必要 -> どのように変換するのかポート番号の働きを知る

ポート番号とウェルノウンポート
- 常に開いてなければならないポートがウェルノウンポート
    - SSHでは22

ルータとポート番号とアドレス変換
- ポート22番に送られてきた通信を全てSSHサーバーに転送するようにルータを設定
- ブロードバンドルータで，ポートフォワーディングする(できないとSSH無理)

ダイナミックIPアドレス
- 一般的な常時接続サービスでは固定的なIPアドレスは割り当てられない
- 一定の周期でIPアドレスが変化(ダイナミックIPアドレス)
- ダイナミックDNSサービスを利用する or 固定IPサービスを利用する

### 第3章 SSHの技術的な基礎を考える
SSHプロトコルには1.x系と2.x系の2種類がある．また，プロトコル1.5とプロトコル2.0との違い

#### 3-1 SSHプロトコルの概要
"SSH"の意味
- SSHプロトコル(本章)
- SSHプロトコルを実装したソフトウェア(第4章)

リモートアクセスの動作コントロール，認証，暗号化の機能の実現と手続きをまとめたのがSSHプロトコル

1.x系プロトコルを実装しているソフトウェアと2.0を実装しているソフトウェア間では認証プロトコルに互換性がない．

#### 3-2 SSHで使われている暗号技術の概要
- 共通鍵暗号方式 (common key cryptography): 1つの鍵で暗号化&復号化(SSHではデータ通信に用いる)
- 公開鍵暗号方式 (public-key cryptography): 暗号化用の鍵と復号化用の鍵が異なる(SSHでは認証に用いる)

共通鍵暗号方式
- DES (data encryption standard)
    - 1970年代にIBMが基礎開発した暗号方式(1977年にアメリカ商務省標準局(ANSI)がデータ暗号化規格(data encryption standard)を公募した時にIBMが提出し，改良))
    - 平文に対してデータの置換操作と位置を入れ替える転置操作(単純な処理)を複数回組み合わせて暗号化
    - 昔は置換専用のハードウェアを必要としていた
    - 現在最も普及している暗号の一つ
- 3DES (triple-DES)
    - DESの暗号化/復号化処理を異なった鍵で3段階実行する
    - SSH2のデータ送信時の標準方式
- IDEA (international data encryption algorithm)
    - 1991年にスイスのJames MasseyとXuejia Laiによって考案
    - 12bit長の鍵を用いて64bitのブロック毎の処理
    - SSH1やPGP (pretty good privacy: 電子メールの暗号化で有名)に使用されている(欧米を中心に普及)
- Blowfish
    - Bruce Schneierによって開発されたSSH1で採用されている暗号方式
    - 32bitから448bit長の鍵を使用して暗号化(SSH1では128bit長の鍵を使用)
    - 処理が高速

公開鍵暗号方式
- 1976年にW.DiffieとM.Hellmanにより公開鍵と秘密鍵のアイディアが提案
- 通信するコンピュータがお互いの公開鍵を持ち合う
- 暗号化&復号化の手順
    1. メッセージの受け手は一組の公開鍵と秘密鍵を作成
    2. 通信相手に公開鍵を送る
    3. 通信相手は公開鍵で暗号文を作成して，受け手に送る
    4. 受け手は送られてきた暗号文を秘密鍵で復号する
- RSAとDSA
    - RSA
        - 最もポピュラー
        - 1977年にR.L.RivestとA.Shamir, L.Adelman(全員数学者)によって考案(頭文字でRSA)
        - 大きな整数を素因数分解するのが非常に困難であるという性質を利用
    - DSA (digital signature algorithm)
        - 1994年のアメリカ政府の標準暗号技術として定められたDSS (digital signature standard)の中の一つとして選択(アメリカ政府関係の電子署名では標準の方式)
        - SSH1には採用されてないが，SSH2では標準となっている
- 処理が遅い

SSHでの暗号方式の使われ方
- 公開鍵暗号方式で，共通鍵を転送する
- 共通鍵は使い捨て
- 共通鍵を送付するシステム(SSHプロトコル1とSSHプロトコル2)
    - SSHプロトコル1
        - 共通鍵を送付するための鍵「サーバ鍵」を用いる
        - サーバ側で生成される公開鍵暗号方式の鍵
        - サーバはサーバ鍵の公開鍵をユーザー側に渡し，ユーザーはその鍵を使ってユーザー側で作った共通鍵を暗号化して送る
    - SSHプロトコル2: Diffie-Helman方式
        - 鍵自体の交換を行うことなくクライアントとサーバの双方で同じ鍵を生成する仕組み
        - クライアントとサーバがランダムな数を生成 -> 同じ鍵で暗号化し交換
        - 2つの暗号化データを組み合わせてある手法で共通鍵を作ると，同じ鍵が生成される
        - ネットワーク上に鍵を流すことなく同じ鍵が双方の端末で所有できる

#### 3-3 SSHで使われる認証技術
ホスト認証とユーザー認証

ホスト認証
- サーバ側がクライアントによって認証される
- SSH1ではホスト認証にRSA方式の暗号化技術を用いる
- SSH2ではホスト認証は
    0. サーバは自分を認証するための公開鍵と秘密鍵を作成してクライアントからのアクセスをまつ
    1. クライアントがサーバに接続の要求を送る
    2. サーバはクライアントの情報をチェックする．初めてのアクセスであれば，クライアントに自分の公開鍵を渡す
    3. クライアントはランダムに生成した数値データをサーバからもらった公開鍵を使って暗号化する．このとき，ランダムに生成した数値データの原文を保存しておく
    4. クライアントは暗号化した数値データをサーバ側に送る
    5. サーバはその数値データを自分の秘密鍵で復号する
    6. サーバは復号化した数値データをクライアントに送り返す
    7. クライアントは，ランダムに生成した数値データの原文とサーバから送られてきた数値データを比較する
    - 双方のデータが一致すれば，サーバ側は正しい秘密鍵を持っていることが確認できる
    - ホスト鍵：ホスト認証のときに使用される鍵(公開鍵&秘密鍵含める)
        - 1024bitのRSA方式 or DSA方式(SSHプロトコル2)で生成される
- SSHクライアントはSSHサーバのホスト鍵の公開鍵をサーバのIPアドレスやホスト名とともに入手

ユーザー認証
- パスワード認証
    1. クライアントは，ユーザーが入力したパスワードをサーバに送る(暗号化する)
    2. サーバはUNIXに用意されているパスワード認証ルーチンでチェックをする
- 公開鍵認証: ホスト認証と同じ
    - SSHクライアント側で公開鍵と秘密鍵を生成(SSH1ではRSA方式，SSH2ではDSA方式)
    0. 公開鍵を事前にサーバに送付，鍵の生成の際にはパスフレーズを入力する
    1. クライアントはサーバに接続の要求
    2. クライアントはサーバに公開鍵を送付
    3. サーバは接続してきているユーザ名の公開鍵ファイルと送付された公開鍵が一致していることを確認
    4. サーバはランダムに生成した数値データを公開鍵で暗号化して送る(原文は保存)
    5. クライアントはそれを復元する(パスワードが必要)
    6. 復号化したデータのチェックサムをハッシュ関数MD5で作成し，その結果をサーバに送る
    7. サーバはチェックサムMD5を比較する
- rhosts認証: rhosts(ファイル)にリモートアクセス相手のコンピュータ情報を保存することで認証
- rhosts RSA認証: rhosts認証と公開鍵認証を組み合わせた認証方法
- 許可されている認証を順番に試す
    - SSH1: rhosts -> rhosts RSA -> Public Key -> Password
    - SSH2: Public Key -> Password
- 一番安全なのが公開鍵，一番手軽なのがパスワード
- SSH2ではrhosts系認証の代わりにHostbased認証がある

#### 3-4 SSHで対処できること・対処できないこと
SSHで対処できること
- 認証によって対処できる事柄
    - IPスプーフィングからのクラッキング
    - ソースルーティングを使ったIPスプーフィング攻撃
        - ソースルーティング: 送信データと返信データが必ず通過する場所を指定
    - DNS偽装
- 暗号化によって対処できる事柄
    - 平文パスワードの盗み見
    - データの盗み見，改ざん

SSHで対処できないこと
- マシンが直接クラッキングされてしまうこと(秘密鍵の意味がない)
- 通信環境の不具合(DoSやDDoSにも)

SSHで対処できないことへの対処
- 別のセキュリティ技術を使用
- SSHの鍵を別の記憶装置に保存して持ち運ぶ

#### 3-5 第4章に進む前に
インターネット越しのアクセス

ブロードバンドルータの設定
- ポートフォワーディング(DMZ機能，インターネットサーバ機能)

ダイナミックIPアドレスへの対処
- ダイナミックDNS

### 第4章 OpenSSHをインストールする
#### 4-1 SSHにもいろいろある
3つの系統
- SSH Secure Shell (SSH1, SSH2)
    - OSS (商用利用はライセンス費用発生) by SSH Communications Security社
- OpenSSH
    - OSS (SSH1を元にしたSSH2と同じ機能で，GPLライセンス(GNU General Public License))
- LSH
    - GNUライセンス
    - SSH2.0プロトコル専用のソフトウェア

OpenSSH
- OpenSSH Server: サーバ用のソフト
    - 設定は"/etc/ssh/sshd_config"から
- OpenSSH Client: クライアント用をソフト
    - 設定は"/etc/ssh/ssh_config"

SSHの確認
- `$ rpm -q -a | grep openss`

最新版(ソース)をインストールする
- OpenSSHの前にOpenSSLをインストール
    - "http://www.openssl.org/"
    1. 展開 `$ tar xvf opnessl-0.9.7c-tar.gz`し，そこへ移動
    2. コンパイル `$ ./configure`, `make`, `make test`
    3. インストール `$ sudo make install`
- OpenSSHをインストール
    - "http://www.openssh.org/", "http://www.openssh.org/ja/"
    - OpenSSLと同様に展開，コンパイル，インストール

#### 4-3 WindowsでOpenSSHを使うためにCygwinをインストールする
Windowsのファイルシステム
- FAT or NTFS
- ディスクのプロパティから確認できる
- CygwinはNTFSの方が良い

### 第5章 OpenSSHサーバ/クライアントの設定を行う
#### 5-1 OpenSSHサーバの設定をする
"sshd_config"による設定(Linux)
- `Port 22`: 使用するポート番号の指定(22がウェルノウンポート)
- `Protocol 2,1`: 使用するSSHプロトコルの指定(2がダメだったら1)
- `ListenAddress 0.0.0.0`: 接続可能なアドレス(ネットワークカード)の指定(0.0.0.0は全てという指定)
    - IPアドレスごとに受け付けるポートを変更することも可能(e.g. 127.168.0.2:2568)
- `HostKey /etc...`: 秘密鍵の名前と場所の指定(SSH1とSSH2のプロトコルごとに用意されている)
    - rootのみで読めるように権限を設定する．
- `KeyRegenerationInterval 3600`: SSHプロトコル1で使用するサーバ鍵の再生成までの間隔(秒数)
    - 0で再生成されなくなる
- `ServerKeyBits 768`: SSH1サーバ鍵のビット数
- `SyslogFacility AUTH`: ログのファシリティ指定
- `LogLevel INFO`: Syslogに送られるログのレベルを指定(QUIET, FATAL, ERROR, INFO, VERBOSE, DEBUG; 後者になるにつれ多くのログを収集)
- `LoginGraceTime 120`: アクセスからログイン(認証成功)までの制限時間を秒数で指定(0で無制限)
- `PermitRootLogin no`: rootアカウントでのログインを可能にするかどうか．yesのが良い．yes/no以外にオプションでの指定ができる
- `StrictModes yes`: クライアントとサーバとのファイルやディレクトリのパーミッションを確認するかどうか．yesのがよい．
- `RSAAuthentication yes`: RSA認証での接続を許可するかどうか．SSHプロトコル1を使用しているときに適応
- `PubkeyAuthentication yes`: 公開鍵認証での接続を許可するかどうか．SSHプロトコル2を使用しているときに適応
- `AuthorizedKeysFile .ssh/authorized_keys`: SSHのユーザー認証で使用する公開鍵のディレクトリとファイル名を指定
- `RhostsAuthentication no`: rhosts認証を許可するか．noのがよい
- `IgnoreRhosts yes`: rhosts関連のファイルを無視するかどうか．
- `RhostsRSAAuthentication no`: rhosts RSA認証を許可するかどうか．noのがよい
- `HostbasedAuthentication no`: ホストベース認証の許可
- `IgnoreUserKnownHosts no`: rhosts RSA認証を使うときに使用するKnown_hostsファイルを無視するかどうかを選択
- `PasswordAuthentication no`: パスワード認証を許可するかどうか
- `PermitEmptyPasswords no`: 空のパスワードを持つユーザーに接続を許可するかどうか．noがよい
- チャレンジレスポンス認証について
- Kerberos認証について
- `X11Forwarding no`: X11のポート転送を許可するかどうか
- `X11DisplayOffset 10`: X11の転送を行ったときのディスプレイ番号を指定
- `PrintMod yes`: ログイン時に"/etc/motd"の内容を表示するかどうかの選択
- `PrintLastLog yes`: 前回の接続時間等をログイン時に表示するか
- `KeepAlive yes`: キープアライブメッセージを送るかどうか
- `UseLogin no`: loginプログラムを使用するかどうかを選択，これがyesだとX11転送は許可されない
- `UsePrivilegeSeparation yes`: root権限を分離するか
- `PermitUserEnvironment no`: ユーザーの環境変数変更を許可するか
- `Compression yes`: データを圧縮してやり取りするかどうか
- `MaxStartups 10`: 認証がなされていない段階の接続を，サーバがどれだけ受け付けるかの指定
    - sshdに対する接続要求をいくつまで認めるか
- `UseDNS yes`: クライアントのIPアドレスを逆引きでチェックするか(DNS偽装のチェック)
- `Subsystem sftp /usr/sbin/sftp-sever`: 外部システムの設定
    - 一般的にsftp-serverは設定しておいた方がよい

設定の反映
- `$ killall -HUP sshd`

#### 5-2 OpenSSHクライアントの設定をする
"ssh_config"による設定
- ".ssh/config"は個々のユーザーの設定(こっちのが優先度は高い)

ユーザー認証用の公開鍵・秘密鍵を作成する
- `$ /user/bin/ssh-keygen -t rsa`
    - パスフレーズ入力
    - "/user/.ssh/"以下に，"id_rsa"と"id_rsa.pub"ができる．

公開鍵をSSHサーバーに登録(ディスクで)
- "/user/.ssh/"を作る
- 公開鍵をディレクトリに収める
- 権限変更と登録
```sh
$ chmod 744 ~/.ssh
$ cd .ssh
$ cat id_rsa.pub >> authorized_keys
$ chmod 600 authorized_keys
```

windowsのSSHサーバーに公開鍵を送付するためには
- windowsでは"."から始まるフォルダを作成できない．
- FTPクライアントを用いるとできる
- OpenSSHで生成するならいらない
